# cluster/images/provider-proxmox-crossplane/Makefile

include ../../../build/makelib/common.mk
include ../../../build/makelib/imagelight.mk

IMAGE = $(REGISTRY)/$(PROJECT_NAME)-$(TARGETARCH)
PLATFORMS ?= linux_amd64 linux_arm64
TARGETOS ?= linux
TARGETARCH ?= amd64

.PHONY: img.build
img.build:
	@$(INFO) docker build $(IMAGE)
	@mkdir -p $(IMAGE_TEMP_DIR)/bin/$(TARGETOS)_$(TARGETARCH)
	@cp ../../../bin/$(TARGETOS)_$(TARGETARCH)/provider $(IMAGE_TEMP_DIR)/bin/$(TARGETOS)_$(TARGETARCH)/ || $(FAIL)
	@cp Dockerfile $(IMAGE_TEMP_DIR)/ || $(FAIL)
	@docker buildx build \
		--platform $(TARGETOS)/$(TARGETARCH) \
		--build-arg TARGETOS=$(TARGETOS) \
		--build-arg TARGETARCH=$(TARGETARCH) \
		-t $(IMAGE):$(VERSION) \
		--load \
		$(IMAGE_TEMP_DIR) || $(FAIL)
	@$(OK) docker build $(IMAGE)

.PHONY: img.publish
img.publish:
	@docker push $(IMAGE):$(VERSION)
	@docker tag $(IMAGE):$(VERSION) $(IMAGE):latest
	@docker push $(IMAGE):latest

.PHONY: package
package.%:
	@echo "üîç Packaging Provider for Architecture: $*"
	@echo "üìÇ Package Root: $(PACKAGE_ROOT)"
	@echo "üåç Current Directory: $(shell pwd)"

	@mkdir -p $(PACKAGE_ROOT)/_output
	@mkdir -p $(PACKAGE_ROOT)/temp

	@test -f $(PACKAGE_ROOT)/crossplane.yaml || (echo "‚ùå ERROR: crossplane.yaml not found" && exit 1)

	@cp $(PACKAGE_ROOT)/crossplane.yaml $(PACKAGE_ROOT)/temp/crossplane.yaml
	@sed -i 's|$${REGISTRY_IMAGE}|$(REGISTRY)/$(PROJECT_NAME)-$*|g' $(PACKAGE_ROOT)/temp/crossplane.yaml
	@sed -i 's|$${VERSION}|$(VERSION)|g' $(PACKAGE_ROOT)/temp/crossplane.yaml

	@echo "üì¶ Building package with crossplane xpkg..."
	@cd $(PACKAGE_ROOT) && \
		crossplane xpkg build \
			--package-root temp \
			--embed-runtime-image=$(REGISTRY)/$(PROJECT_NAME)-$*:$(VERSION) \
			-o $(PACKAGE_ROOT)/_output/$(PROJECT_NAME)-$*.xpkg || \
		(echo "‚ùå Packaging failed" && exit 1)

	@echo "üîç Verifying package..."
	@crossplane xpkg inspect $(PACKAGE_ROOT)/_output/$(PROJECT_NAME)-$*.xpkg || \
		(echo "‚ùå Package verification failed" && exit 1)

	@echo "‚úÖ Successfully created and verified package: $(PROJECT_NAME)-$*.xpkg"